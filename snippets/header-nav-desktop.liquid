<nav class="header__menu header-desktop__menu{% if mobile_menu != blank %} desktop-menu__hide{% endif %}">
  <ul class="menu__list main-menu__list">
    {%- for link in main_menu.links -%}
      {%- liquid
        assign is_megamenu = false
        for block in section.blocks
         if block.type == 'mega-menu' and link.title == block.settings.menu_item_label
           assign is_megamenu = true
           assign menu_associations[link.title] = block.settings.mega_menu
           break
         endif
        endfor
       
      -%}
      {%- if is_megamenu == false -%}
        <li class="menu__item">
          <a
            href="{{ link.url }}"
            title="{{ link.title }}"
            class="menu-item__link">
            {{ link.title }}
            {%- if link.links != blank -%}
              {%- render 'icon-arrow-down' -%}
            {%- endif -%}
          </a>
          {% if link.links != blank %}
            <ul class="menu__list child-menu__list">
              {%- for childlink in link.links -%}
                <li class="menu__item child-menu__item">
                  <a
                    href="{{ childlink.url }}"
                    title="{{ childlink.title }}"
                    class="menu-item__link child-menu__item--link">{{ childlink.title }}
                    {%- if childlink.links != blank -%}
                      {%- render 'icon-arrow-down' -%}
                    {%- endif -%}
                  </a>
                  {%- if childlink.links != blank %}
                    <ul class="menu__list grandchild-menu__list">
                      {%- for grandchild in childlink.links -%}
                        <li class="menu__item grandchild-menu__item">
                          <a
                            href="{{ grandchild.url }}"
                            title="{{ grandchild.title }}"
                            class="menu-item__link grandchild-menu__item--link">{{ grandchild.title }}</a>
                        </li>
                      {%- endfor -%}
                    </ul>
                  {%- endif -%}
                </li>
              {%- endfor -%}
            </ul>
          {%- endif -%}
        </li>
        {%- elsif is_megamenu -%}
        <li class="mega-menu__item">
          <a class="menu-item__link" href="{{ link.url }}" title="{{ link.title }}">{{ link.title }}
          {%- if is_megamenu -%}
            {%- render 'icon-arrow-down' -%}
          {%- endif -%}
          </a>
          {%- if is_megamenu -%}
            {%- for block in section.blocks -%}
              {%- if block.type == 'mega-menu' -%}
                {%- liquid
                   assign content_position = block.settings.content_position
                   assign text_alignment = block.settings.text_alignment
                   assign promo_image_1 = block.settings.promo_image_1
                   assign promo_1_subheading = block.settings.promo_image_1_subheading
                   assign promo_1_heading = block.settings.promo_image_1_heading
                   assign promo_1_text = block.settings.promo_image_2_text
                   assign promo_image_2 = block.settings.promo_image_2
                   assign promo_2_subheading = block.settings.promo_image_2_subheading
                   assign promo_2_heading = block.settings.promo_image_2_heading
                   assign promo_2_text = block.settings.promo_image_2_text
                   assign associated_menu = menu_associations[link.title]
                -%}
                <div class="mega-menu__container">
                  <div class="page__width">
                    <div class="mega-container__flex">
                {% if associated_menu %}
                      <div class="mega-container__block mega-menu__dropdowns">         
                        <div class="mega-menu__list">
                          {%- for link in linklists[block.settings.mega_menu].links -%}
                            <div class="mega-menu__item">
                              <a class="mega-item__link" href="{{ link.url }}" title="{{ link.title }}">
                                <h4>{{ link.title }}</h4>
                              </a>
                              {%- if link.links != blank -%}
                                <div class="child-mega__list">
                                  {%- for childlink in link.links -%}
                                  <div class="child-mega__item">
                                    <a class="mega-item__link" href="{{ childlink.url }}" title="{{ childlink.title }}">{{ childlink.title }}</a>
                                  </div>
                                  {%- endfor -%}
                                </div>
                              {%- endif -%}
                            </div>
                          {%- endfor -%}
                        </div>
                      </div>
                {% endif %}
                      <div class="mega-container__block mega-menu__images">
                        <div class="mega-image__block">
                          <div class="mega-image__element">
                            {%- if promo_image_1 != blank -%}
                              {{ promo_image_1 | image_url: width: promo_image_1.width, height: promo_image_1.height | image_tag: sizes: '100vw', widths: '240,600,768,1024,2048',class: 'mega-promo__image' }}
                            {%- else -%}
                              {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder__image' }}
                            {%- endif -%}
                          </div>
                          <div class="mega-image__content">
                            <div class="mega-content__overlay text__position-{{ content_position }}">
                              <div class="mega-content__wrapper text__align-{{ text_alignment }}">
                                {%- if promo_1_subheading != blank -%}
                                  <div class="mega-overlay__subheading">{{ promo_1_subheading }}</div>
                                {%- endif -%}
                                {%- if promo_1_heading != blank -%}
                                  <div class="main__heading mega-overlay__heading"><h2>{{ promo_1_heading }}</h2></div>
                                {%- endif -%}
                                {%- if promo_1_text != blank -%}
                                  <div class="mega-overlay__text">{{ promo_1_text }}</div>
                                {%- endif -%}
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="mega-image__block">
                          <div class="mega-image__element">
                            {%- if promo_image_2 != blank -%}
                            {{ promo_image_2 | image_url: width: promo_image_2.width, height: promo_image_2.height | image_tag: sizes: '100vw', widths: '240,600,768,1024,2048',class: 'mega-promo__image' }}
                            {%- else -%}
                              {{ 'lifestyle-2' | placeholder_svg_tag: 'placeholder__image' }}
                            {%- endif -%}
                          </div>
                          <div class="mega-image__content">
                            <div class="mega-content__overlay text__position-{{ content_position }}">
                              <div class="mega-content__wrapper text__align-{{ text_alignment }}">
                                {%- if promo_2_subheading != blank -%}
                                  <div class="mega-overlay__subheading">{{ promo_2_subheading }}</div>
                                {%- endif -%}
                                {%- if promo_2_heading != blank -%}
                                  <div class="main__heading mega-overlay__heading"><h2>{{ promo_2_heading }}</h2></div>
                                {%- endif -%}
                                {%- if promo_2_text != blank -%}
                                  <div class="mega-overlay__text">{{ promo_2_text }}</div>
                                {%- endif -%}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        </li>
      {%- endif -%}
    {%- endfor -%}
  </ul>
</nav>